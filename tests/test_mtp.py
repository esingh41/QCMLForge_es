import numpy as np


def CLIFF_T_ij():
    return np.array(
        [
            [
                1.78040147e-01,
                -3.16859506e-02,
                -8.78783686e-04,
                1.00614204e-04,
                1.12739546e-02,
                4.69193553e-04,
                -5.37191764e-05,
                4.69193553e-04,
                -5.63055625e-03,
                -1.48985702e-06,
                -5.37191764e-05,
                -1.48985702e-06,
                -5.64339837e-03,
            ],
            [
                3.16859506e-02,
                -1.12739546e-02,
                -4.69193553e-04,
                5.37191764e-05,
                6.01461229e-03,
                3.33945970e-04,
                -3.82343328e-05,
                3.33945970e-04,
                -3.00159234e-03,
                -1.32575536e-06,
                -3.82343328e-05,
                -1.32575536e-06,
                -3.01301995e-03,
            ],
            [
                8.78783686e-04,
                -4.69193553e-04,
                5.63055625e-03,
                1.48985702e-06,
                3.33945970e-04,
                -3.00159234e-03,
                -1.32575536e-06,
                -3.00159234e-03,
                -2.50382348e-04,
                9.53112714e-06,
                -1.32575536e-06,
                9.53112714e-06,
                -8.35636214e-05,
            ],
            [
                -1.00614204e-04,
                5.37191764e-05,
                1.48985702e-06,
                5.64339837e-03,
                -3.82343328e-05,
                -1.32575536e-06,
                -3.01301995e-03,
                -1.32575536e-06,
                9.53112714e-06,
                -8.35636214e-05,
                -3.01301995e-03,
                -8.35636214e-05,
                2.87032056e-05,
            ],
            [
                1.12739546e-02,
                -6.01461229e-03,
                -3.33945970e-04,
                3.82343328e-05,
                4.27669209e-03,
                2.97047379e-04,
                -3.40097182e-05,
                2.97047379e-04,
                -2.13224550e-03,
                -1.41549072e-06,
                -3.40097182e-05,
                -1.41549072e-06,
                -2.14444660e-03,
            ],
            [
                4.69193553e-04,
                -3.33945970e-04,
                3.00159234e-03,
                1.32575536e-06,
                2.97047379e-04,
                -2.13224550e-03,
                -1.41549072e-06,
                -2.13224550e-03,
                -2.22689447e-04,
                8.46822492e-06,
                -1.41549072e-06,
                8.46822492e-06,
                -7.43579316e-05,
            ],
            [
                -5.37191764e-05,
                3.82343328e-05,
                1.32575536e-06,
                3.01301995e-03,
                -3.40097182e-05,
                -1.41549072e-06,
                -2.14444660e-03,
                -1.41549072e-06,
                8.46822492e-06,
                -7.43579316e-05,
                -2.14444660e-03,
                -7.43579316e-05,
                2.55414933e-05,
            ],
            [
                4.69193553e-04,
                -3.33945970e-04,
                3.00159234e-03,
                1.32575536e-06,
                2.97047379e-04,
                -2.13224550e-03,
                -1.41549072e-06,
                -2.13224550e-03,
                -2.22689447e-04,
                8.46822492e-06,
                -1.41549072e-06,
                8.46822492e-06,
                -7.43579316e-05,
            ],
            [
                -5.63055625e-03,
                3.00159234e-03,
                2.50382348e-04,
                -9.53112714e-06,
                -2.13224550e-03,
                -2.22689447e-04,
                8.46822492e-06,
                -2.22689447e-04,
                1.59766026e-03,
                7.07118488e-07,
                8.46822492e-06,
                7.07118488e-07,
                5.34585234e-04,
            ],
            [
                -1.48985702e-06,
                1.32575536e-06,
                -9.53112714e-06,
                8.35636214e-05,
                -1.41549072e-06,
                8.46822492e-06,
                -7.43579316e-05,
                8.46822492e-06,
                7.07118488e-07,
                5.34585234e-04,
                -7.43579316e-05,
                5.34585234e-04,
                7.08372235e-07,
            ],
            [
                -5.37191764e-05,
                3.82343328e-05,
                1.32575536e-06,
                3.01301995e-03,
                -3.40097182e-05,
                -1.41549072e-06,
                -2.14444660e-03,
                -1.41549072e-06,
                8.46822492e-06,
                -7.43579316e-05,
                -2.14444660e-03,
                -7.43579316e-05,
                2.55414933e-05,
            ],
            [
                -1.48985702e-06,
                1.32575536e-06,
                -9.53112714e-06,
                8.35636214e-05,
                -1.41549072e-06,
                8.46822492e-06,
                -7.43579316e-05,
                8.46822492e-06,
                7.07118488e-07,
                5.34585234e-04,
                -7.43579316e-05,
                5.34585234e-04,
                7.08372235e-07,
            ],
            [
                -5.64339837e-03,
                3.01301995e-03,
                8.35636214e-05,
                -2.87032056e-05,
                -2.14444660e-03,
                -7.43579316e-05,
                2.55414933e-05,
                -7.43579316e-05,
                5.34585234e-04,
                7.08372235e-07,
                2.55414933e-05,
                7.08372235e-07,
                1.60986137e-03,
            ],
        ]
    )

def eval_interaction_individual_components(
    RA, qA, muA, thetaA, RB, qB, muB, thetaB, ZA=None, ZB=None, traceless=False
):
    T0, T1, T2, T3, T4 = T_cart(RA, RB)

    # Most inputs will already be traceless, but we can ensure this is the case
    if not traceless:
        traceA = np.trace(thetaA)
        thetaA[0, 0] -= traceA / 3.0
        thetaA[1, 1] -= traceA / 3.0
        thetaA[2, 2] -= traceA / 3.0
        traceB = np.trace(thetaB)
        thetaB[0, 0] -= traceB / 3.0
        thetaB[1, 1] -= traceB / 3.0
        thetaB[2, 2] -= traceB / 3.0
    print(RA, RB)

    E_qq = np.sum(T0 * qA * qB)
    E_qu = np.sum(T1 * (qA * muB - qB * muA))
    E_qQ = np.sum(T2 * (qA * thetaB + qB * thetaA)) * (1.0 / 3.0)

    E_uu = np.sum(T2 * np.outer(muA, muB)) * (-1.0)
    E_uQ = np.sum(
        T3 * (np.multiply.outer(muA, thetaB) - np.multiply.outer(muB, thetaA))
    ) * (-1.0 / 3.0)

    E_QQ = np.sum(T4 * np.multiply.outer(thetaA, thetaB)) * (1.0 / 9.0)
    if ZA is not None and ZB is not None:
        E_qq += np.sum(T0 * ZA * qB)
        E_qq += np.sum(T0 * ZB * qA)
        E_qq += np.sum(T0 * ZA * ZB)
    return E_qq, E_qu, E_uu, E_qQ, E_uQ, E_QQ


def T_cart(RA, RB):
    dR = RB - RA
    R = np.linalg.norm(dR)

    delta = np.identity(3)

    T0 = R**-1
    T1 = (R**-3) * (-1.0 * dR)
    T2 = (R**-5) * (3 * np.outer(dR, dR) - R * R * delta)

    Rdd = np.multiply.outer(dR, delta)
    T3 = (R**-7) * (
        -15 * np.multiply.outer(np.outer(dR, dR), dR)
        + 3 * R * R * (Rdd + Rdd.transpose(1, 0, 2) + Rdd.transpose(2, 0, 1))
    )

    RRdd = np.multiply.outer(np.outer(dR, dR), delta)
    dddd = np.multiply.outer(delta, delta)
    T4 = (R**-9) * (
        105 * np.multiply.outer(np.outer(dR, dR), np.outer(dR, dR))
        - 15
        * R
        * R
        * (
            RRdd
            + RRdd.transpose(0, 2, 1, 3)
            + RRdd.transpose(0, 3, 2, 1)
            + RRdd.transpose(2, 1, 0, 3)
            + RRdd.transpose(3, 1, 2, 0)
            + RRdd.transpose(2, 3, 0, 1)
        )
        + 3 * (R**4) * (dddd + dddd.transpose(0, 2, 1, 3) + dddd.transpose(0, 3, 2, 1))
    )

    return T0, T1, T2, T3, T4


def run_QQ():
    RA, RB = (
        np.array([-1.32695822, -0.10593854, 0.01878815]),
        np.array([4.28756329e00, 4.97755800e-02, 9.60040000e-04]),
    )
    T0, T1, T2, T3, T4 = T_cart(RA, RB)
    # print("T0:", T0)
    # print("T1:", T1)
    # print("T2:", T2)
    # print("T3:", T3)
    # print("T4:", T4)
    T_ij = CLIFF_T_ij()
    np.set_printoptions(precision=6, suppress=True)
    assert np.allclose(T0, T_ij[0, 0])
    assert np.allclose(T1, T_ij[0, 1:4])
    print('q-mu')
    print(T1)
    print(T_ij[0, 1:4])
    print(T_ij[1:4, 0])
    assert np.allclose(T1, -T_ij[1:4, 0])
    print('q-mu')
    print(T2)
    print(T_ij[0, 1:4])
    print(T_ij[1:4, 0])
    assert np.allclose(T2, -T_ij[1:4, 1:4])

    print('mu-theta')
    print(T3.shape, T_ij[4:13, 1:4].shape)
    print(T3, T_ij[4:13, 1:4], sep='\n')
    assert np.allclose(T3, T_ij[4:13, 1:4])
    return


def main():
    run_QQ()
    return


if __name__ == "__main__":
    main()
